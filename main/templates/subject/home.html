{%extends "base.html"%}
{% load crispy_forms_tags %}

{%block head%}

    <script type="text/javascript">
    $(document).ready(function(){
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";

        var app = new Vue({
        
            delimiters: ['[[', ']]'],
            el: '#root',        
            data:{
                session_day_subject_actvity:{heart_activity:"--",
                                             immune_activity:"--",
                                             current_heart_pay:"--",
                                             current_immmune_pay:"--",
                                             current_heart_earnings:"--",
                                             current_immune_earnings:"--",
                                             current_total_earnings:"--",
                                             heart_maintenance_minutes:"--",
                                             immune_maintenance_hours:"--", 
                                             heart_improvment_minutes:{target_activity: "--",target_minutes:"--"},
                                             immune_improvment_hours:{target_activity: "--",target_hours:"--"}                                      
                                             },
                session_day_subject_actvity_previous:{heart_activity_minutes:"--",
                                                      immune_activity_hours:"--",},
                graph_parameters:{},
                parameterset:{},
                payMeButtonText : 'Pay Me <i class="fab fa-paypal fa-lg"></i>',
                refreshButtonText : '<i class="fas fa-sync fa-spin"></i>',
                toggleState:"heart",
                fitbitError:false,
                consent_required:false,
                consent_form_text:"",
                session_date:"--/--/----",
                paymentError:false,
               
            },

            methods:{

                getSessionDaySubject:function(){                    
                    
                    axios.post('/subjectHome/{{id}}/', {
                                    action :"getSessionDaySubject" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.updateSessionDaySubject(response);    
                                    app.$data.refreshButtonText = '<i class="fas fa-sync"></i>';  

                                    app.$data.consent_required = response.data.consent_required;
                                    app.$data.consent_form_text = response.data.consent_form_text;

                                    app.toggleConsentForm();
                                                                           
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                getSessionDaySubjectButton:function()
                {
                    app.$data.refreshButtonText = '<i class="fas fa-sync fa-spin"></i>';
                    app.getSessionDaySubject();
                },
                
                updateSessionDaySubject:function(response){
                    app.$data.session_day_subject_actvity = response.data.session_day_subject_actvity;

                    app.$data.session_date = response.data.session_date;

                    if (response.data.session_day_subject_actvity_previous)
                        app.$data.session_day_subject_actvity_previous=response.data.session_day_subject_actvity_previous;

                    if (app.$data.session_day_subject_actvity)
                    {
                        app.$data.graph_parameters = response.data.graph_parameters;       
                        app.$data.fitbitError = response.data.fitbitError;

                        Vue.nextTick(app.updateCanvases());          
                    }
                },   

                toggleConsentForm:function()
                {
                    if(app.$data.consent_required)
                    {
                        $('#consentModal').modal({backdrop: 'static', keyboard: false}).show();
                    }
                    else
                    {
                        if(($("#consentModal").data('bs.modal') || {})._isShown)
                        {
                            $('#consentModal').modal('toggle');
                        }
                    } 
                },

                acceptConsentForm:function(){

                    axios.post('/subjectHome/{{id}}/', {
                                    action :"acceptConsentForm",                                                                                                                                                                
                                })
                                .then(function (response) {    
                                    
                                    app.$data.consent_required = response.data.consent_required;
                                    app.toggleConsentForm();
                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },

                payMe:function(reponse){
                    app.$data.payMeButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                    axios.post('/subjectHome/{{id}}/', {
                                    action :"payMe" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.$data.session_day_subject_actvity = response.data.session_day_subject_actvity;    
                                    app.$data.payMeButtonText = 'Pay Me <i class="fab fa-paypal fa-lg"></i>';     

                                    if(response.data.status == "fail")
                                        app.$data.paymentError=true;
                                    else
                                        app.$data.paymentError=false;    

                                })
                                .catch(function (error) {
                                    console.log(error);
                                });
                },

                updateCanvases:function(){
                           
                    gp=app.$data.graph_parameters;

                    if(app.$data.toggleState == "heart")
                    {
                    app.drawAxis("healthChart",gp.y_min_heart,gp.y_max_heart,gp.y_ticks_heart,
                                                  gp.x_min_heart,gp.x_max_heart,gp.x_ticks_heart,
                                                  "Tomorrow's Heart Health","Today's Minutes Exercising");
                    
                    app.drawLine("healthChart",gp.y_min_heart,gp.y_max_heart,
                                                  gp.x_min_heart,gp.x_max_heart,
                                                  app.$data.session_day_subject_actvity.heart_activity_future,0,"crimson");
                    }
                    else
                    {
                    app.drawAxis("healthChart",gp.y_min_immune,gp.y_max_immune,gp.y_ticks_immune,
                                                  gp.x_min_immune,gp.x_max_immune,gp.x_ticks_immune,
                                                  "Tomorrow's Sleep Health","Today's Hours Sleeping");    

                    app.drawLine("healthChart",gp.y_min_immune,gp.y_max_immune,
                                                  gp.x_min_immune*60,gp.x_max_immune*60,
                                                  app.$data.session_day_subject_actvity.immune_activity_future,0,"cornflowerBlue");  
                    }          
                },   

                drawAxis: function (chartID,yMin,yMax,yTickCount,xMin,xMax,xTickCount,yLabel,xLabel){
            
                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');     

                    var xScale = xMax-xMin;
                    var yScale = yMax-yMin;

                    var w = ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;
                    
                    var xTickValue=xScale/parseFloat(xTickCount);
                    var yTickValue=yScale/parseFloat(yTickCount);
                
                    ctx.moveTo(0,0);

                    //clear screen
                    // ctx.fillStyle = "white";
                    // ctx.fillRect(0,0,w,h);
                    ctx.clearRect(0,0,w,h);
                    ctx.strokeStyle="black";
                    ctx.lineWidth=3;

                    //axis
                    ctx.beginPath();
                    ctx.moveTo(marginY, margin2);
                    ctx.lineTo(marginY, h-marginX);
                    ctx.lineTo(w-margin2, h-marginX);
                    ctx.lineWidth = 3;
                    ctx.lineCap = "round";
                    ctx.stroke();

                    //y ticks
                    ctx.beginPath();                                                               
                    ctx.font="12px Georgia";
                    ctx.fillStyle = "black";
                    ctx.textAlign = "right";

                    var tempY = h-marginX;     
                    var tempYValue = yMin;

                    for(var i=0;i<=yTickCount;i++)
                    {                                       
                        ctx.moveTo(marginY, tempY);                                   
                        ctx.lineTo(marginY-5, tempY);
                        ctx.fillText(tempYValue,marginY-8,tempY+4);

                        tempY -= ((h-marginX-margin2)/ (yTickCount));
                        tempYValue += yTickValue;
                    }

                    ctx.stroke();

                    //x ticks
                    ctx.beginPath();                                                               
                    ctx.textAlign = "center";

                    var tempX = marginY;
                    var tempXValue=xMin;                                
                    for(var i=0;i<=xTickCount;i++)
                    {                                       
                        ctx.moveTo(tempX, h-marginX);                                   
                        ctx.lineTo(tempX,  h-marginX+5);
                        ctx.fillText(Math.round(tempXValue).toString(),tempX,h-marginX+18);

                        tempX += ((w-marginY-margin2)/ (xTickCount));
                        tempXValue += xTickValue;
                    }

                    ctx.stroke();

                    //labels
                    ctx.textAlign = "center";
                    ctx.fillStyle = "DimGray";
                    ctx.font="bold 14px Georgia"; 

                    ctx.save();
                    ctx.translate(14, h/2);
                    ctx.rotate(-Math.PI/2);                                                              
                    ctx.fillText(yLabel,0,0);
                    ctx.restore();

                    ctx.fillText(xLabel,w/2,h-4);
                    ctx.restore();                       
                    },

                drawLine: function (chartID,yMin,yMax,xMin,xMax,dataSet,markerWidth,markerColor){


                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');           

                    var w =  ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;

                    ctx.save();

                    ctx.translate(marginY, h-marginX);
                    ctx.moveTo(0, 0);

                    ctx.beginPath();
                    for(i=0;i<dataSet.length;i++)
                    {
                        x = app.convertToX(dataSet[i].x,xMax,xMin,w-marginY-margin2,markerWidth);
                        y = app.convertToY(dataSet[i].y,yMax,yMin,h-marginX-margin2,markerWidth);

                        ctx.lineTo(x,y);
                    }    

                    ctx.strokeStyle=markerColor;
                    ctx.lineWidth=markerWidth;
                    ctx.stroke();    
                    ctx.restore();                                         
                    },

                convertToX:function(tempValue,maxValue,minValue,tempWidth, markerWidth){
                    tempT = tempWidth / (maxValue-minValue);

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return (tempT * tempValue - markerWidth/2);
                },

                convertToY:function(tempValue,maxValue,minValue,tempHeight, markerHeight){
                    tempT = tempHeight / (maxValue-minValue);

                    if(tempValue > maxValue) tempValue=maxValue;
                    if(tempValue < minValue) tempValue=minValue;

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return(-1 * tempT * tempValue - markerHeight/2)
                },

                updateToogleState:function(toggleState){
                   app.$data.toggleState = toggleState;
                   Vue.nextTick(app.updateCanvases());    
                },

                                        
            },

            mounted: function(){
                this.getSessionDaySubject();                      
            },
        });

    });

    </script>

{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col col-lg-6">
        <div class="card">                  
            <div class="card-header">
                <span >{{session_subject.contact_email}}</span>               
                <span class="float-right">
                    {%if session_started and not before_start_date %}
                        <button class="btn btn-outline-primary btn-sm" type="button" v-on:click = "getSessionDaySubjectButton()">
                            <span v-html='refreshButtonText'></span>
                        </button>                    
                        <span v-html = "session_date"></span>
                    {%endif%}
                </span>                                                                  
            </div>
            <div class="card-body">    
                {%if not session_started or before_start_date %}
                    <div class="row">
                        <div class="col" style="text-align: center;">
                            The experiment has not yet started.<br>
                            It will begin on {{start_date}}.
                        </div>
                    </div>
                {%else%}
                    <div class="row">
                        <div class="col" style="text-align: center;">
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-secondary active">
                                    <input type="radio" name="options" id="option1" autocomplete="off" checked v-on:click="updateToogleState('heart')"> <i class="far fa-heart"></i>
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="options" id="option2" autocomplete="off" v-on:click="updateToogleState('immune')"> <i class="fas fa-bed"></i>
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="options" id="option2" autocomplete="off" v-on:click="updateToogleState('payment')"> <i class="fas fa-dollar-sign"></i>
                                </label>                    
                            </div>
                        </div>
                    </div>
                
                    <div v-if="toggleState==='heart'">
                        <div class="row mt-2">
                            <div class="col" style="text-align: center;">Heart Health: <span style="font-weight: bold;" v-html = session_day_subject_actvity.heart_activity></span></div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">                             
                                <div v-if="fitbitError">
                                    Yesterday's Active Minutes: <span style="font-weight: bold;color: red;" v-html = "'FitBit Error'"></span>
                                </div>
                                <div v-else>
                                    Yesterday's Active Minutes: <span style="font-weight: bold;" v-html = session_day_subject_actvity_previous.heart_activity_minutes></span>
                                </div>                            
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                Minutes Required to<br>Maintain Health at <span v-html = session_day_subject_actvity.heart_activity></span>: <span v-html="session_day_subject_actvity.heart_maintenance_minutes"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                Minutes Required to<br>Improve Health to <span v-html = session_day_subject_actvity.heart_improvment_minutes.target_activity></span>: <span v-html = session_day_subject_actvity.heart_improvment_minutes.target_minutes></span>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="toggleState==='immune'">
                        <div class="row mt-2">
                            <div class="col" style="text-align: center;">Sleep Health: <span style="font-weight: bold;" v-html = session_day_subject_actvity.immune_activity></span></div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">                             
                                <div v-if="fitbitError">
                                    Yesterday's Hours Sleeping: <span style="font-weight: bold;color: red;" v-html = "'FitBit Error'"></span>
                                </div>
                                <div v-else>
                                    Yesterday's Hours Sleeping: <span style="font-weight: bold;" v-html = session_day_subject_actvity_previous.immune_activity_hours></span>
                                </div>                            
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                Hours Required to<br>Maintain Health at <span v-html = session_day_subject_actvity.immune_activity></span>: <span v-html="session_day_subject_actvity.immune_maintenance_hours"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                Hours Required to<br>Improve Health to <span v-html = session_day_subject_actvity.immune_improvment_hours.target_activity></span>: <span v-html="session_day_subject_actvity.immune_improvment_hours.target_hours"></span>
                            </div>
                        </div>
                    </div>  
                    <div v-else-if="toggleState==='payment'">
                        <div class="row mt-2">
                            <div class="col" style="text-align: center;">Your Payment today = </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col" style="text-align: center;">(Fixed Pay per Day)</div>
                        </div>
                        <div class="row mt">
                            <div class="col" style="text-align: center;">+ (Heart Pay) x (Today's Heart Health)</div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">+ (Immune Pay) x (Today's Immune Health)</div>
                        </div>
                        <div class="row mt-3">
                            <div class="col" style="text-align: center;">$[[session_day_subject_actvity.fixed_pay_per_day]]</div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">+ $[[session_day_subject_actvity.current_heart_pay]] x ([[session_day_subject_actvity.heart_activity]])</div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: center;">+ $[[session_day_subject_actvity.current_heart_pay]] x ([[session_day_subject_actvity.immune_activity]])</div>
                        </div>
                        <div class="row mt-3">
                            <div class="col" style="text-align: center;">$[[session_day_subject_actvity.fixed_pay_per_day]] + $[[session_day_subject_actvity.current_heart_earnings]] + $[[session_day_subject_actvity.current_immune_earnings]] = $[[session_day_subject_actvity.current_total_earnings]]</div>
                        </div>
                        <div class = "row mt-4">
                            <div class="col" style="text-align: center;">
                                <div v-if="session_day_subject_actvity.paypal_today">
                                    <span style="color: red;" v-html="'Your payment is on the way.<br>Check your email.'"></span>
                                </div>
                                <div v-else>
                                    <button class="btn btn-outline-primary" type="button" v-on:click = "payMe()">
                                        <span v-html="payMeButtonText"></span>
                                    </button>
                                    <div v-show="paymentError">
                                        <span v-html="'***Payment Error***'" style="color: red;"></span>
                                    </div>
                                </div>    
                                
                            </div>
                        </div>
                    </div>

                    <div v-show="toggleState != 'payment'">
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                <canvas key="healthChart" id="healthChart" style="border-style: solid;border-width: 1px;" width="300" height="325"></canvas>
                            </div>
                        </div>
                    </div>
                {%endif%}
                
                
            </div>                    
        </div>                
    </div>
</div>    

{%include "modals/consentModal.html"%}

{%endblock content%}