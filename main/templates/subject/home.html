{%extends "base.html"%}
{% load crispy_forms_tags %}

{%block head%}

    <script type="text/javascript">
    $(document).ready(function(){
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";

        var app = new Vue({
        
            delimiters: ['[[', ']]'],
            el: '#root',        
            data:{
                session_day_subject_actvity:{heart_activity:"--",
                                             immune_activity:"--",
                                             current_heart_pay:"--",
                                             current_immmune_pay:"--",
                                             current_heart_earnings:"--",
                                             current_immune_earnings:"--",
                                             current_total_earnings:"--",
                                             heart_maintenance_minutes:"--",
                                             immune_maintenance_hours:"--", 
                                             heart_improvment_minutes:{target_activity: "--",target_minutes:"--"},
                                             immune_improvment_hours:{target_activity: "--",target_hours:"--"},   
                                             time_on_wrist:"--"                                 
                                             },
                session_day_subject_actvity_previous:{heart_activity_minutes:"--",
                                                      immune_activity_hours:"--",
                                                      time_on_wrist:"--",},
                graph_parameters:{},
                payMeButtonText : 'Pay Me <i class="fab fa-paypal fa-lg"></i>',
                refreshButtonText : '<i class="fas fa-sync fa-spin"></i>',
                toggleState:"heart",
                session_complete:false,
                session_canceled:false,
                fitbitError:true,
                consent_required:false,
                consent_signature:"",
                questionnaire1_required:false,
                questionnaire2_required:false,
                consent_form_text:"",
                session_date:"--/--/----",
                session_last_day:false,
                paymentError:false,
                status:"success",
                questionnaire1_ids : {{session_subject_questionnaire1_form_ids|safe|escape}},
                questionnaire2_ids : {{session_subject_questionnaire2_form_ids|safe|escape}},          
                helpText:"",             
                helpTitle:"Help",    
                heart_help_text:`{{heart_help_text|safe}}`, 
                immune_help_text:`{{immune_help_text|safe}}`, 
                payment_help_text:`{{payment_help_text|safe}}`,   
                fitbit_link:"",
                fitBitLastSynced:"---",
                fitBitTimeRequired:"---",
                fitBitTimeRequirementMet:true,
                notification_title:"",
                notification_text:"",
                session_treatment:"",
                viewed_heart:false,
                viewed_immune:false,
                payment_toggle_background : "lightgrey",
                payment_available : true,
                soft_delete:false,
            },

            methods:{

                getSessionDaySubject:function(){                    
                    
                    axios.post('/subjectHome/{{id}}/', {
                                    action :"getSessionDaySubject" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.$data.status = response.data.status;

                                    app.$data.soft_delete = response.data.soft_delete;

                                    if(app.$data.status != "fail")
                                    {
                                        app.updateSessionDaySubject(response);    
                                        app.$data.refreshButtonText = '<i class="fas fa-sync"></i>';  
                                        
                                        app.$data.session_complete = response.data.session_complete;                                       
                                        app.$data.session_last_day = response.data.session_last_day;
                                        app.$data.fitBitTimeRequired = response.data.fitBitTimeRequired;
                                        app.$data.fitBitTimeRequirementMet = response.data.fitBitTimeRequirementMet;
                                    }
                                    else
                                    {
                                        app.$data.refreshButtonText = '<i class="fas fa-exclamation-circle"></i>';                                
                                    }

                                    app.$data.consent_required = response.data.consent_required;
                                    app.$data.consent_form_text = response.data.consent_form_text;
                                    app.$data.questionnaire1_required = response.data.questionnaire1_required;
                                    app.$data.questionnaire2_required = response.data.questionnaire2_required;
                                    app.$data.fitbit_link = response.data.fitbit_link;  
                                    app.$data.fitbitError = response.data.fitbitError;       
                                    app.$data.fitBitLastSynced = response.data.fitBitLastSynced;                     

                                    if(!app.$data.soft_delete)
                                    {
                                        app.toggleConsentForm();
                                        app.toggleQuesionnaire1();
                                        app.toggleQuesionnaire2();
                                        app.toogleNotification();
                                        
                                    }                                 

                                    if(app.$data.toggleState == 'heart')
                                    {
                                        app.$data.viewed_heart = true;
                                    }
                                    else
                                    {
                                        app.$data.viewed_heart = false;
                                    }

                                    if(app.$data.toggleState == 'immune')
                                    {
                                        app.$data.viewed_immune = true;
                                    }
                                    else
                                    {
                                        app.$data.viewed_immune = false;
                                    }
                                                                           
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                submitQuestionnaire1:function(){                    
                   
                    axios.post('/subjectHome/{{id}}/', {
                                    action :"submitQuestionnaire1" ,      
                                    formData : $("#questionnaire1Form").serializeArray(),                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    status=response.data.status;                               

                                    app.clearMainFormErrors();

                                    if(status=="success")
                                    {
                                        app.$data.questionnaire1_required = response.data.questionnaire1_required;
                                        app.toggleQuesionnaire1();
                                        app.toggleQuesionnaire2();
                                        app.toogleNotification();
                                    } 
                                    else
                                    {                                                                 
                                        app.displayErrors(response.data.errors);
                                    }                                   
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                submitQuestionnaire2:function(){                    
                   
                   axios.post('/subjectHome/{{id}}/', {
                                   action :"submitQuestionnaire2" ,      
                                   formData : $("#questionnaire2Form").serializeArray(),                                                                                                                                                          
                               })
                               .then(function (response) {     
                                   status=response.data.status;                               

                                   app.clearMainFormErrors();

                                   if(status=="success")
                                   {
                                       app.$data.questionnaire2_required = response.data.questionnaire2_required;
                                       app.toggleQuesionnaire2();
                                       app.toogleNotification();
                                   } 
                                   else
                                   {                                                                 
                                       app.displayErrors(response.data.errors);
                                   }                                   
                               })
                               .catch(function (error) {
                                   console.log(error);
                               });                        
               },

                getSessionDaySubjectButton:function()
                {
                    app.$data.refreshButtonText = '<i class="fas fa-sync fa-spin"></i>';
                    app.getSessionDaySubject();
                },
                
                updateSessionDaySubject:function(response){
                    app.$data.session_day_subject_actvity = response.data.session_day_subject_actvity;

                    app.$data.session_date = response.data.session_date;
                    app.$data.notification_title = response.data.notification_title;
                    app.$data.notification_text = response.data.notification_text;

                    if (response.data.session_day_subject_actvity_previous)
                        app.$data.session_day_subject_actvity_previous=response.data.session_day_subject_actvity_previous;

                    if (app.$data.session_day_subject_actvity)
                    {
                        app.$data.graph_parameters = response.data.graph_parameters;      
                        
                        Vue.nextTick(app.updateCanvases());          
                    }
                },   

                toggleConsentForm:function()
                {
                    if(app.$data.consent_required)
                    {
                        $('#consentModal').modal({backdrop: 'static', keyboard: false}).show();
                    }
                    else
                    {
                        if(($("#consentModal").data('bs.modal') || {})._isShown)
                        {
                            $('#consentModal').modal('toggle');
                        }
                    } 
                },

                toggleQuesionnaire1:function()
                {                    
                    if(app.$data.questionnaire1_required && !app.$data.consent_required)
                    {
                        $('#questionnaire1Modal').modal({backdrop: 'static', keyboard: false}).show();
                    }
                    else
                    {
                        if(($("#questionnaire1Modal").data('bs.modal') || {})._isShown)
                        {
                            $('#questionnaire1Modal').modal('toggle');
                        }
                    } 
                },

                toggleQuesionnaire2:function()
                {                    
                    if(app.$data.questionnaire2_required &&
                       !app.$data.consent_required &&
                       !app.$data.questionnaire1_required &&
                       app.session_last_day)
                    {
                        $('#questionnaire2Modal').modal({backdrop: 'static', keyboard: false}).show();
                    }
                    else
                    {
                        if(($("#questionnaire2Modal").data('bs.modal') || {})._isShown)
                        {
                            $('#questionnaire2Modal').modal('toggle');
                        }
                    } 
                },

                toogleNotification:function(){
                    if(!app.$data.questionnaire2_required &&
                       !app.$data.consent_required &&
                       !app.$data.questionnaire1_required &&
                       app.$data.notification_text != ""
                       )
                    {

                        app.$data.helpTitle = app.$data.notification_title;
                        app.$data.helpText = app.$data.notification_text;
                        $('#helpModal').modal('show');
                
                    }
                },

                acceptConsentForm:function(){

                    if(app.$data.consent_signature=="")
                    {
                        alert("Please type your full name.")
                        return;
                    }

                    axios.post('/subjectHome/{{id}}/', {
                                    action :"acceptConsentForm",   
                                    consent_signature : app.$data.consent_signature,                                                                                                                                                             
                                })
                                .then(function (response) {    
                                    
                                    app.$data.consent_required = response.data.consent_required;
                                    app.toggleConsentForm();
                                    app.toggleQuesionnaire1();
                                    app.toggleQuesionnaire2();
                                    app.toogleNotification();

                                })
                                .catch(function (error) {
                                    console.log(error);                                    
                                });                        
                },

                payMe:function(){

                    if(!app.$data.viewed_heart)
                    {
                        alert("Please confirm your Heart Health before payment.")
                        return;
                    }

                    if(!app.$data.viewed_immune)
                    {
                        alert("Please confirm your Sleep Health before payment.")
                        return;
                    }

                    app.$data.payMeButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                    axios.post('/subjectHome/{{id}}/', {
                                    action :"payMe" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.$data.session_day_subject_actvity = response.data.session_day_subject_actvity;  
                                    app.$data.session_complete = response.data.session_complete;

                                    app.$data.payMeButtonText = 'Pay Me <i class="fab fa-paypal fa-lg"></i>';     

                                    if(response.data.status == "fail")
                                        app.$data.paymentError=true;
                                    else
                                        app.$data.paymentError=false;    

                                })
                                .catch(function (error) {
                                    console.log(error);
                                });
                },

                updateCanvases:function(){
                           
                    gp=app.$data.graph_parameters;

                    if(app.$data.toggleState == "heart")
                    {
                    app.drawAxis("healthChart",gp.y_min_heart,gp.y_max_heart,gp.y_ticks_heart,
                                                  gp.x_min_heart,gp.x_max_heart,gp.x_ticks_heart,
                                                  "Tomorrow's Heart Health","Today's Minutes Exercising");
                    
                    app.drawLine("healthChart",gp.y_min_heart,gp.y_max_heart,
                                                  gp.x_min_heart,gp.x_max_heart,
                                                  app.$data.session_day_subject_actvity.heart_activity_future,0,"crimson");
                    }
                    else
                    {
                    app.drawAxis("healthChart",gp.y_min_immune,gp.y_max_immune,gp.y_ticks_immune,
                                                  gp.x_min_immune,gp.x_max_immune,gp.x_ticks_immune,
                                                  "Tomorrow's Sleep Health","Today's Hours Sleeping");    

                    app.drawLine("healthChart",gp.y_min_immune,gp.y_max_immune,
                                                  gp.x_min_immune*60,gp.x_max_immune*60,
                                                  app.$data.session_day_subject_actvity.immune_activity_future,0,"cornflowerBlue");  
                    }          
                },   

                drawAxis: function (chartID,yMin,yMax,yTickCount,xMin,xMax,xTickCount,yLabel,xLabel){
            
                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');     

                    var xScale = xMax-xMin;
                    var yScale = yMax-yMin;

                    var w = ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;
                    
                    var xTickValue=xScale/parseFloat(xTickCount);
                    var yTickValue=yScale/parseFloat(yTickCount);
                
                    ctx.moveTo(0,0);

                    //clear screen
                    // ctx.fillStyle = "white";
                    // ctx.fillRect(0,0,w,h);
                    ctx.clearRect(0,0,w,h);
                    ctx.strokeStyle="black";
                    ctx.lineWidth=3;

                    //axis
                    ctx.beginPath();
                    ctx.moveTo(marginY, margin2);
                    ctx.lineTo(marginY, h-marginX);
                    ctx.lineTo(w-margin2, h-marginX);
                    ctx.lineWidth = 3;
                    ctx.lineCap = "round";
                    ctx.stroke();

                    //y ticks
                    ctx.beginPath();                                                               
                    ctx.font="12px Georgia";
                    ctx.fillStyle = "black";
                    ctx.textAlign = "right";

                    var tempY = h-marginX;     
                    var tempYValue = yMin;

                    for(var i=0;i<=yTickCount;i++)
                    {                                       
                        ctx.moveTo(marginY, tempY);                                   
                        ctx.lineTo(marginY-5, tempY);
                        ctx.fillText(tempYValue,marginY-8,tempY+4);

                        tempY -= ((h-marginX-margin2)/ (yTickCount));
                        tempYValue += yTickValue;
                    }

                    ctx.stroke();

                    //x ticks
                    ctx.beginPath();                                                               
                    ctx.textAlign = "center";

                    var tempX = marginY;
                    var tempXValue=xMin;                                
                    for(var i=0;i<=xTickCount;i++)
                    {                                       
                        ctx.moveTo(tempX, h-marginX);                                   
                        ctx.lineTo(tempX,  h-marginX+5);
                        ctx.fillText(Math.round(tempXValue).toString(),tempX,h-marginX+18);

                        tempX += ((w-marginY-margin2)/ (xTickCount));
                        tempXValue += xTickValue;
                    }

                    ctx.stroke();

                    //labels
                    ctx.textAlign = "center";
                    ctx.fillStyle = "DimGray";
                    ctx.font="bold 14px Georgia"; 

                    ctx.save();
                    ctx.translate(14, h/2);
                    ctx.rotate(-Math.PI/2);                                                              
                    ctx.fillText(yLabel,0,0);
                    ctx.restore();

                    ctx.fillText(xLabel,w/2,h-4);
                    ctx.restore();                       
                    },

                drawLine: function (chartID,yMin,yMax,xMin,xMax,dataSet,markerWidth,markerColor){


                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');           

                    var w =  ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;

                    ctx.save();

                    ctx.translate(marginY, h-marginX);
                    ctx.moveTo(0, 0);

                    ctx.beginPath();
                    for(i=0;i<dataSet.length;i++)
                    {
                        x = app.convertToX(dataSet[i].x,xMax,xMin,w-marginY-margin2,markerWidth);
                        y = app.convertToY(dataSet[i].y,yMax,yMin,h-marginX-margin2,markerWidth);

                        ctx.lineTo(x,y);
                    }    

                    ctx.strokeStyle=markerColor;
                    ctx.lineWidth=markerWidth;
                    ctx.stroke();    
                    ctx.restore();                                         
                    },

                convertToX:function(tempValue,maxValue,minValue,tempWidth, markerWidth){
                    tempT = tempWidth / (maxValue-minValue);

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return (tempT * tempValue - markerWidth/2);
                },

                convertToY:function(tempValue,maxValue,minValue,tempHeight, markerHeight){
                    tempT = tempHeight / (maxValue-minValue);

                    if(tempValue > maxValue) tempValue=maxValue;
                    if(tempValue < minValue) tempValue=minValue;

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return(-1 * tempT * tempValue - markerHeight/2)
                },

                updateToogleState:function(toggleState){
                   app.$data.toggleState = toggleState;

                   if(app.$data.toggleState == 'heart')
                    {
                        app.$data.viewed_heart = true;
                    }                    

                    if(app.$data.toggleState == 'immune')
                    {
                        app.$data.viewed_immune = true;
                    }                    

                    Vue.nextTick(app.updateCanvases());    
                },

                displayErrors:function(errors){
                    for(var e in errors)
                    {
                        $("#id_" + e).attr("class","form-control is-invalid")
                        var str='<span id=id_errors_'+ e +' class="text-danger">';
                        
                        for(var i in errors[e])
                        {
                            str +=errors[e][i] + '<br>';
                        }

                        str+='</span>';
                        $("#div_id_" + e).append(str); 

                        var elmnt = document.getElementById("div_id_" + e);
                        elmnt.scrollIntoView(); 

                    }
                }, 

                clearMainFormErrors:function(){
                    for(i=0;i<app.$data.questionnaire1_ids.length;i++)
                    {
                        item = app.$data.questionnaire1_ids[i];
                        $("#id_" + item).attr("class","form-control");
                        $("#id_errors_" + item).remove();
                    }

                    for(i=0;i<app.$data.questionnaire2_ids.length;i++)
                    {
                        item = app.$data.questionnaire2_ids[i];
                        $("#id_" + item).attr("class","form-control");
                        $("#id_errors_" + item).remove();
                    }

                    for(var item in app.$data.questionnaire2_ids)
                    {
                        $("#id_" + item).attr("class","form-control");
                        $("#id_errors_" + item).remove();
                    }

                },

                showHelpBox:function(){                

                    if(app.$data.toggleState=='heart')
                    {
                        app.$data.helpTitle = "Heart Help"
                        app.$data.helpText = app.$data.heart_help_text;
                    }
                    else if(app.$data.toggleState=='immune')
                    {
                        app.$data.helpTitle = "Sleep Help"
                        app.$data.helpText = app.$data.immune_help_text;
                    }
                    else if (app.$data.toggleState == 'payment')
                    {
                        app.$data.helpTitle = "Payment Help"
                        app.$data.helpText = app.$data.payment_help_text;
                    }

                    $('#helpModal').modal('show');                   
                },

                hideHelpBox:function(){
                    app.$data.helpText="";
                },                        
            },

            mounted: function(){
                {%if status == "success" %}
                    this.getSessionDaySubject();      
                    $('#hideHelpBox').on("hidden.bs.modal", this.hideHelpBox);   
                {%endif%}             
            },
        });

    });

    </script>

    <style>
        [v-cloak] {
        display: none;
        }
    </style>

{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col col-lg-6">
        <div class="card">                  
            <div class="card-header">
                <span >{{session_subject.contact_email}}</span>               
                <span class="float-right">
                    {%if session_started and not before_start_date and not session_complete and not session_canceled %}
                        <button v-show="status === 'success'" class="btn btn-outline-primary btn-sm" type="button" v-on:click = "getSessionDaySubjectButton()">
                            <span v-html='refreshButtonText'></span>
                        </button>                    
                        <span v-html = "session_date"></span>
                    {%endif%}
                </span>                                                                  
            </div>
            <div class="card-body">
                {%if status == "fail" %}    
                <div class="row">
                    <div class="col" style="text-align: center;">
                        Invalid login.<br>
                        Please contact {{contact_email}} if you have lost your login link.
                    </div>
                </div>
                {%elif session_canceled%}
                    <div class="row">
                        <div class="col" style="text-align: center;">
                            The study has been canceled.<br>
                            <u>Please return your Fitbit.</u><br>
                            No further action is required on your part.
                        </div>
                    </div>
                {%elif not session_started or before_start_date %}
                    <div class="row">
                        <div class="col" style="text-align: center;">
                            The study has not yet started.<br>
                            <div v-if="fitbitError">
                                Please connect your Fitbit before {{start_date}}.<br>
                                <a v-bind:href="fitbit_link" style="font-weight: bold;color: red;">Connect Fitbit</a>
                            </div>
                            <div v-else>
                                Your Fitbit is connected.<br>
                                The study will begin on {{start_date}}.                                
                            </div>                             
                        </div>
                    </div>
                {%elif session_complete or soft_delete%}
                    <div class="row">
                        <div class="col" style="text-align: center;">
                            The study is complete.<br>
                            <u>Please return your Fitbit.</u><br>
                            Thank you for your participation!
                        </div>
                    </div>
                {%else%}
                    <div v-if='status==="success"'>
                        <div class="row">
                            <div class="col-2">
                            </div>
                            <div class="col-8" style="text-align: center;">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary active">
                                        <input type="radio" name="options" id="option1" autocomplete="off" checked v-on:click="updateToogleState('heart')"> <i class="far fa-heart"></i>
                                    </label>
                                    <label class="btn btn-secondary">
                                        <input type="radio" name="options" id="option2" autocomplete="off" v-on:click="updateToogleState('immune')"> <i class="fas fa-bed"></i>
                                    </label>
                                    <label class="btn btn-secondary" v-bind:style="[(viewed_heart === false || viewed_immune === false) && session_day_subject_actvity.paypal_today ===false ? {'background-color': 'lightgrey' }:{}]">
                                        <input type="radio" name="options" id="option2" autocomplete="off" v-on:click="updateToogleState('payment')"> <i class="fas fa-dollar-sign"></i>
                                    </label>                    
                                </div>
                            </div>
                            <div class="col-2" style="text-align: right;">
                                <button type="button" class="btn btn-link" id="helpButton" style="text-align: right;" data-placement="bottom" v-on:click="showHelpBox()">
                                    <i class="far fa-question-circle"></i> 
                                </button>
                            </div>
                        </div>
                    
                        <div v-if="toggleState==='heart'">
                            <div class="row mt-1">
                                <div class="col" style="text-align: center;">Heart Health Score: <span style="font-weight: bold;" v-html = session_day_subject_actvity.heart_activity></span></div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">                             
                                    <div v-if="fitbitError">
                                        Yesterday's Active Minutes: <a v-bind:href="fitbit_link" style="font-weight: bold;color: red;">Connect Fitbit</a>
                                    </div>
                                    <div v-else>
                                        Yesterday's Active Minutes: <span style="font-weight: bold;" v-html = session_day_subject_actvity_previous.heart_activity_minutes></span>
                                    </div>                            
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col" style="text-align: center;">
                                    Minutes Required to:
                                </div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">
                                    Maintain Score at <span v-html = session_day_subject_actvity.heart_activity></span>: <span v-html="session_day_subject_actvity.heart_maintenance_minutes"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">
                                    Improve Score to <span v-html = session_day_subject_actvity.heart_improvment_minutes.target_activity></span>: <span v-html = session_day_subject_actvity.heart_improvment_minutes.target_minutes></span>
                                </div>
                            </div>
                        </div>
                        <div v-else-if="toggleState==='immune'">
                            <div class="row mt-1">
                                <div class="col" style="text-align: center;">Sleep Health Score: <span style="font-weight: bold;" v-html = session_day_subject_actvity.immune_activity></span></div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">                             
                                    <div v-if="fitbitError">
                                        Yesterday's Hours Sleeping: <a v-bind:href="fitbit_link" style="font-weight: bold;color: red;">Connect Fitbit</a>
                                    </div>
                                    <div v-else>
                                        Yesterday's Hours Sleeping: <span style="font-weight: bold;" v-html = session_day_subject_actvity_previous.immune_activity_hours></span>
                                    </div>                            
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col" style="text-align: center;">
                                    Hours Required to:
                                </div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">
                                    Maintain Score at <span v-html = session_day_subject_actvity.immune_activity></span>: <span v-html="session_day_subject_actvity.immune_maintenance_hours"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col" style="text-align: center;">
                                    Improve Score to <span v-html = session_day_subject_actvity.immune_improvment_hours.target_activity></span>: <span v-html="session_day_subject_actvity.immune_improvment_hours.target_hours"></span>
                                </div>
                            </div>
                        </div>  
                        <div v-else-if="toggleState==='payment'">
                            {%if baseline_payment %}
                                <div class="row mt-2">
                                    <div class="col" style="text-align: center;">Your Payment today = </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col" style="text-align: center;">(Fixed Pay per Day)</div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col" style="text-align: center;">$[[session_day_subject_actvity.fixed_pay_per_day]]</div>
                                </div>                               
                                
                                <div class = "row mt-4" v-cloak>
                                    <div class="col" style="text-align: center;">
                                        <div v-if="session_day_subject_actvity.paypal_today">
                                            <span style="color: red;" v-html="'Your payment will arrive tomorrow morning.<br>Check your email.'"></span>
                                            <div v-show="session_complete">
                                                <span style="color: red;" v-html="'The study is complete, thank you for your participation!<br><u>Please return your Fitbit.</u>'"></span>
                                            </div>
                                        </div>
                                        <div v-else-if="session_complete===false">
                                            
                                            <button class="btn btn-outline-primary" type="button" v-on:click = "payMe()" v-bind:disabled="fitbitError">
                                                <span v-html="payMeButtonText"></span>
                                            </button>
                                            <div v-show="fitbitError">
                                                <a v-bind:href="fitbit_link" style="font-weight: bold;color: red;">Connect Fitbit</a>
                                            </div>
                                            <div v-show="paymentError">
                                                <span v-html="'***Payment Error***'" style="color: red;"></span>
                                            </div>
                                        </div>  
                                    </div>                                    
                                </div>

                                <div class = "row mt-4">
                                    <div class="col" style="text-align: center;">
                                        Daily wrist time required: <span v-html="fitBitTimeRequired"></span>
                                    </div>
                                </div>
                                <div class = "row">
                                    <div class="col" style="text-align: center;" v-bind:style="[fitBitTimeRequirementMet ===false ? {'color': 'red' }:{}]">
                                        Yesterday's time on wrist: <span v-html="session_day_subject_actvity_previous.time_on_wrist"></span>
                                    </div>
                                </div>
                            {%else%}
                                <div class="row mt-2">
                                    <div class="col" style="text-align: center;">Your Payment today = </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col" style="text-align: center;">(Fixed Pay per Day)</div>
                                </div>
                                <div class="row mt">
                                    <div class="col" style="text-align: center;">+ (Heart Pay) x (Today's Heart Score)</div>
                                </div>
                                <div class="row">
                                    <div class="col" style="text-align: center;">+ (Sleep Pay) x (Today's Sleep Score)</div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col" style="text-align: center;">$[[session_day_subject_actvity.fixed_pay_per_day]]</div>
                                </div>
                                <div class="row">
                                    <div class="col" style="text-align: center;">+ $[[session_day_subject_actvity.current_heart_pay]] x [[session_day_subject_actvity.heart_activity]]</div>
                                </div>
                                <div class="row">
                                    <div class="col" style="text-align: center;">+ $[[session_day_subject_actvity.current_immune_pay]] x [[session_day_subject_actvity.immune_activity]]</div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col" style="text-align: center;">$[[session_day_subject_actvity.fixed_pay_per_day]] + $[[session_day_subject_actvity.current_heart_earnings]] + $[[session_day_subject_actvity.current_immune_earnings]] = $[[session_day_subject_actvity.current_total_earnings]]</div>
                                </div>
                                <div class = "row mt-4">
                                    <div class="col" style="text-align: center;">
                                        <div v-if="session_day_subject_actvity.paypal_today">
                                            <span style="color: red;" v-html="'Your payment will arrive tomorrow morning.<br>Check your email.'"></span>
                                            <div v-show="session_complete">
                                                <span style="color: red;" v-html="'The study is complete, thank you for your participation!<br><u>Please return your Fitbit.</u>'"></span>
                                            </div>
                                        </div>
                                        <div v-else-if="session_complete===false">
                                            
                                            <button class="btn btn-outline-primary" type="button" v-on:click = "payMe()" v-bind:disabled="fitbitError || fitBitTimeRequirementMet === false"> 
                                                <span v-html="payMeButtonText"></span>
                                            </button>
                                            <div v-show="fitbitError">
                                                <a v-bind:href="fitbit_link" style="font-weight: bold;color: red;">Connect Fitbit</a>
                                            </div>
                                            <div v-show="paymentError">
                                                <span v-html="'***Payment Error***'" style="color: red;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class = "row mt-4">
                                    <div class="col" style="text-align: center;">
                                        Daily wrist time required: <span v-html="fitBitTimeRequired"></span>
                                    </div>
                                </div>
                                <div class = "row">
                                    <div class="col" style="text-align: center;" v-bind:style="[fitBitTimeRequirementMet ===false ? {'color': 'red' }:{}]">
                                        Yesterday's time on wrist: <span v-html="session_day_subject_actvity_previous.time_on_wrist"></span>
                                    </div>
                                </div>
                            {%endif%}
                            
                        </div>

                        <div v-show="toggleState != 'payment'">
                            <div class="row">
                                <div class="col" style="text-align: center;">
                                    <canvas key="healthChart" id="healthChart" style="border-style: solid;border-width: 1px;" width="300" height="325"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <div class="row">
                            <div class="col" style="text-align: center;">
                                There was an error loading the study.<br>
                                Please refresh your browser.
                            </div>
                        </div>
                    </div>
                {%endif%}
                
                
            </div>  
            <div class="card-footer">
                <div class="row">
                    <div class="col" style="text-align: center;">
                        Fitbit last synced: <span v-html="fitBitLastSynced"></span>
                    </div>
                </div>
                {% if not before_start_date %}
                <div class="row mt-2">
                    <div class="col" style="text-align: center;">
                        Today's time on wrist: <span v-html="session_day_subject_actvity.time_on_wrist"></span>
                    </div>
                </div>
                {%endif%}
            </div>                  
        </div>                
    </div>
</div>    

{%include "modals/consentModal.html"%}
{%include "modals/helpModal.html"%}
{%include "modals/questionnaire1Modal.html"%}
{%include "modals/questionnaire2Modal.html"%}

{%endblock content%}