{%extends "base.html"%}
{% load crispy_forms_tags %}

{%block head%}

    <script type="text/javascript">
    $(document).ready(function(){
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";

        var app = new Vue({
        
            delimiters: ['[[', ']]'],
            el: '#root',        
            data:{
                sessionParametersBeforeEdit:{},                     //store session before editing to restore if canceled
                session:{title:"",                                  //session and parameter set values
                         start_date:"",
                         end_date:"",
                         started:false,
                         invitations_sent:false,
                         invitation_text:"",
                         invitation_text_subject:"",
                         cancelation_text:"",
                         cancelation_text_subject:"",
                         email_list:"",
                         current_period:"",
                         parameterset:{id:"",
                                        number_of_days:"",
                                        number_of_players:"",

                                        heart_activity_inital:"",
                                        heart_parameter_1:"",
                                        heart_parameter_2:"",
                                        heart_parameter_3:"",

                                        immune_activity_inital:"",
                                        immune_parameter_1:"",
                                        immune_parameter_2:"",
                                        immune_parameter_3:"",

                                        block_1_heart_pay:"",
                                        block_2_heart_pay:"",
                                        block_3_heart_pay:"",

                                        block_1_immune_pay:"",
                                        block_2_immune_pay:"",
                                        block_3_immune_pay:"",

                                        fixed_pay_per_day:"",
                                        minimum_wrist_minutes:"",

                                        treatment_3_heart_bonus:"",
                                        treatment_3_immune_bonus:"",
                                        treatment_3_bonus_target_count:"",

                                        block_1_day_count:"",
                                        block_2_day_count:"",
                                        block_3_day_count:"",}
                        },
                session_subjects:[],              //list of subjects in this session 
                cancelModal:false,                //if modal is canceled reload old values
                currentSubject:{},                //current subject being edited
                currentSubjectIndex:-1,           //index of current subject being edited
                addSubjectButtonText:'Add Subject <i class="fas fa-plus"></i>',
                showFitbitStatusButtonText:'Check fitbit <i class="far fa-check-circle"></i>',
                backFillButtonText:'Back Fill Data For Testing',
                startSessionButtonText: 'Start Session <i class="far fa-play-circle"></i>',
                invitationButtonText: 'Send Invitations <i class="far fa-envelope"></i>',
                cancelationButtonText: 'Cancel Session <i class="fas fa-ban"></i>',
                downloadDataButtonText:'Download Data <i class="fas fa-scroll fa-xs"></i>',
                downloadEarningsButtonText:'Download Earnings <i class="fas fa-cash-register"></i>',
                downloadParametersetButtonText:'Download <i class="fas fa-download"></i>',
                uploadParametersetButtonText:'Upload  <i class="fas fa-upload"></i>',
                uploadParametersetMessaage:'',
                upload_file: null,
                upload_file_name:'Choose File',
                upload_mode:'',         //parameters or subject
                refreshSubjectTableButtonText:'Auto Refresh: Off <i class="fas fa-sync fa-spin"></i>',
                emailResult:'',
                emailResultCancelation:'',
                helpTitle:"Session Help",
                helpText:`{{help_text|safe}}`,
                toggleState:"heart",
                graph_parameters:{},
                earningsDownloadDate:"{{yesterdays_date}}",
                subject_form_ids:{{subject_form_ids|safe}},
                last_refresh:"",
                auto_refresh:"Off",
            },

            methods:{

                //create new experient
                getSession:function(){                    
                    
                    axios.post('/session/{{id}}/', {
                                    action :"getSession" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.updateSession(response);   
                                    app.updateSubjects(response);    
                                    app.graph_parameters = response.data.graph_parameters;
                                    app.$data.refreshSubjectTableButtonText='Auto Refresh: ' + app.$data.auto_refresh + ' <i class="fas fa-sync"></i>';    
                                    Vue.nextTick(app.updateCanvases());                               
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },
                                
                //take update for the session parameters
                updateSession:function(response){
                    app.$data.session = response.data.session;           
                },

                //take update the subject list
                updateSubjects:function(response){
                    app.$data.session_subjects = response.data.session_subjects;      
                    Vue.nextTick(app.updateCanvases());    
                    
                    app.$data.last_refresh = moment(new Date).local().format('MM/DD/YYYY hh:mm:ss a');                  
                },

                //delete the selected experiment
                deleteSubject:function(id){
                    if(confirm("Delete Subject?"))
                    {
                        axios.post('/session/{{id}}/', {
                            action :"deleteSubject" ,
                            id:id,                                                                                                                             
                        })
                        .then(function (response) {   
                            app.updateSession(response);
                            app.updateSubjects(response);                                                                          
                        })
                        .catch(function (error) {
                            console.log(error);
                        });                        
                    }
                },

                //create new experient
                addSubject:function(){                    
                    app.$data.addSubjectButtonText ='<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"addSubject" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.updateSubjects(response);    
                                    app.updateSession(response);      
                                    app.$data.addSubjectButtonText = 'Add Subject <i class="fas fa-plus"></i>';                                        
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //refresh subject table click
                refreshSubjectTableClick:function(){

                    if(app.$data.auto_refresh == "Off")
                    {
                        app.$data.auto_refresh = "On";
                        this.refreshSubjectTable()
                    }
                    else
                    {
                        app.$data.auto_refresh = "Off";
                        app.$data.refreshSubjectTableButtonText = 'Auto Refresh: ' + app.$data.auto_refresh + ' <i class="fas fa-sync"></i>';
                    }
                },

                //refresh subject table()
                refreshSubjectTable:function(){

                    app.$data.refreshSubjectTableButtonText = 'Auto Refresh: ' + app.$data.auto_refresh + ' <i class="fas fa-sync fa-spin"></i>';

                    axios.post('/session/{{id}}/', {
                                    action :"refreshSubjectTable" ,                                                                                                                                                                
                                })
                                .then(function (response) {     
                                    app.updateSubjects(response);     
                                    app.$data.refreshSubjectTableButtonText = 'Auto Refresh: ' + app.$data.auto_refresh + ' <i class="fas fa-sync"></i>';

                                    if(app.$data.auto_refresh=="On")
                                    {
                                        setTimeout(app.refreshSubjectTable, 10000);            
                                    }                            
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });
                },

                //update session parameters
                updateParameters:function(){                    
                    app.$data.cancelModal=false;

                    axios.post('/session/{{id}}/', {
                                    action :"updateParameters" ,      
                                    formData : $("#parametersetForm").serializeArray(),                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    status=response.data.status;                               

                                    app.clearMainFormErrors();

                                    if(status=="success")
                                    {
                                        app.updateSession(response);       
                                        $('#editSessionParametersModal').modal('toggle');    
                                    } 
                                    else
                                    {
                                        app.$data.cancelModal=true;                           
                                        app.displayErrors(response.data.errors);
                                    }                                   
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //update session parameters
                updateSessionSettings:function(){                    
                    app.$data.cancelModal=false;

                    axios.post('/session/{{id}}/', {
                                    action :"updateSession" ,      
                                    formData : $("#sessionForm").serializeArray(),                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    status=response.data.status;                               

                                    app.clearMainFormErrors();

                                    if(status=="success")
                                    {
                                        app.updateSession(response);       
                                        $('#editSessionModal').modal('toggle');    
                                    } 
                                    else
                                    {
                                        app.$data.cancelModal=true;                           
                                        app.displayErrors(response.data.errors);
                                    }                                   
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //for testing, back fill session days.
                backFillSessionsDays:function(){                    
                    app.$data.backFillButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"backFillSessionDays"                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    app.updateSession(response);   
                                    app.updateSubjects(response);  

                                    app.$data.backFillButtonText = 'Back Fill Data For Testing';                                    
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //activate session and fill session days
                startSession:function(){
                    app.$data.startSessionButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"startSession" ,                                                                                                                                                               
                                })
                                .then(function (response) {     
                                    app.updateSession(response);      
                                    app.$data.startSessionButtonText = 'Start Session <i class="far fa-play-circle"></i>';                          
                                })
                                .catch(function (error) {
                                    console.log(error);
                                }); 
                },

                //send invitations
                sendInvitations:function(){

                    if(app.$data.session.invitation_text_subject == "")
                    {
                        alert("Message has no subject.");
                        return;
                    }

                    if(app.$data.session.invitation_text == "")
                    {
                        alert("Message is empty.");
                        return;
                    }

                    app.$data.invitationButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"sendInvitations" ,  
                                    invitation_text_subject:app.$data.session.invitation_text_subject, 
                                    invitation_text:app.$data.session.invitation_text,                                                                                                                                                            
                                })
                                .then(function (response) {     
                                    app.updateSession(response);      
                                    app.$data.invitationButtonText = 'Send Invitations <i class="far fa-envelope"></i>';   

                                    if( response.data.success)
                                    {
                                        if(response.data.result.errorMessage != "")
                                            app.$data.emailResult = "Error: " + response.data.result.errorMessage;
                                        else
                                            app.$data.emailResult = response.data.result.mailCount + " email(s) were sent.";                                     
                                    }
                                    else
                                    {
                                        app.$data.emailResult =response.data.result;
                                    }
                                                           
                                })
                                .catch(function (error) {
                                    console.log(error);
                                }); 
                },

                //send cancelations
                sendCancelations:function(){
                    if(!confirm("Cancel Session?"))
                    {                        
                        return;
                    }

                    if(app.$data.session.cancelation_text_subject == "")
                    {
                        alert("Message has no subject.");
                        return;
                    }

                    if(app.$data.session.cancelation_text == "")
                    {
                        alert("Message is empty.");
                        return;
                    }

                    app.$data.cancelationButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"sendCancelations" ,  
                                    cancelation_text_subject:app.$data.session.cancelation_text_subject, 
                                    cancelation_text:app.$data.session.cancelation_text,                                                                                                                                                            
                                })
                                .then(function (response) {     
                                    app.updateSession(response);      
                                    app.$data.cancelationButtonText = 'Cancel Session <i class="fas fa-ban"></i>';   

                                    if( response.data.success)
                                    {
                                        if(response.data.result.errorMessage != "")
                                            app.$data.emailResultCancelation = "Error: " + response.data.result.errorMessage;
                                        else
                                            app.$data.emailResultCancelation = response.data.result.mailCount + " email(s) were sent.";                                     
                                    }
                                    else
                                    {
                                        app.$data.emailResultCancelation = response.data.result;
                                    }
                                                        
                                })
                                .catch(function (error) {
                                    console.log(error);
                                }); 
                    },

                //show fitbit connection status for each subject
                showFitbitStatus:function(){                    
                    app.$data.showFitbitStatusButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"showFitbitStatus" ,                                                                                                                                                               
                                })
                                .then(function (response) {     
                                    app.updateSubjects(response);      
                                    app.$data.showFitbitStatusButtonText = 'Check fitbit <i class="far fa-check-circle"></i>';                          
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //copy subject link to clipboard
                copySubjectLinkToClipboard:function(text){

                     // Create a dummy input to copy the string array inside it
                    var dummy = document.createElement("input");

                    // Add it to the document
                    document.body.appendChild(dummy);

                    // Set its ID
                    dummy.setAttribute("id", "dummy_id");

                    // Output the array into it
                    document.getElementById("dummy_id").value=text;

                    // Select it
                    dummy.select();
                    dummy.setSelectionRange(0, 99999); /*For mobile devices*/

                    // Copy its contents
                    document.execCommand("copy");

                    // Remove it as its not needed anymore
                    document.body.removeChild(dummy);

                    /* Copy the text inside the text field */
                    document.execCommand("copy");
                },

                //update subject parameters
                updateSubjectSettings:function(){                    
                    app.$data.cancelModal=false;
                    
                    axios.post('/session/{{id}}/', {
                                    action :"updateSubject" ,
                                    ss_id : app.$data.currentSubject.id,      
                                    formData : $("#subjectForm").serializeArray(),                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    status=response.data.status;                               

                                    app.clearMainFormErrors();

                                    if(status=="success")
                                    {
                                        app.updateSubjects(response);       
                                        $('#editSubjectModal').modal('toggle');    
                                    } 
                                    else
                                    {
                                        app.$data.cancelModal=true;                           
                                        app.displayErrors(response.data.errors);
                                    }                                   
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //download data
                downloadData:function(){                    
                    app.$data.downloadDataButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"downloadData" ,                                                                                                                                                                                              
                                })
                                .then(function (response) {     
                                                             
                                    
                                    console.log(response.data);

                                    var downloadLink = document.createElement("a");
                                    var blob = new Blob(["\ufeff", response.data]);
                                    var url = URL.createObjectURL(blob);
                                    downloadLink.href = url;
                                    downloadLink.download = "FitBit_Session_" + app.$data.session.id +"_Data.csv";

                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);

                                    app.$data.downloadDataButtonText ='Download Data <i class="fas fa-scroll fa-xs"></i>';
                                                                    
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //download earnings
                downloadEarnings:function(){
                    app.$data.downloadEarningsButtonText = '<i class="fas fa-spinner fa-spin"></i>';
                    axios.post('/session/{{id}}/', {
                                    action :"downloadEarnings",
                                    date : app.$data.earningsDownloadDate,                                                                                                                                                                                              
                                })
                                .then(function (response) {    
                                                             
                                    console.log(response.data);

                                    var downloadLink = document.createElement("a");
                                    var blob = new Blob(["\ufeff", response.data]);
                                    var url = URL.createObjectURL(blob);
                                    downloadLink.href = url;
                                    downloadLink.download = "FitBit_Session_" + app.$data.session.id +"_Earnings_" + app.$data.earningsDownloadDate + ".csv";

                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);

                                    app.$data.downloadEarningsButtonText ='Download Earnings <i class="fas fa-cash-register"></i>';
                                                                    
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });
                },

                //download parameter set
                downloadParameterset:function(){
                    app.$data.downloadParametersetButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                    axios.post('/session/{{id}}/', {
                                    action :"downloadParameterset",
                                                                                                                                                                                                      
                                })
                                .then(function (response) {    
                                                             
                                    console.log(response.data.parameterset);

                                    var downloadLink = document.createElement("a");
                                    var jsonse = JSON.stringify(response.data.parameterset);
                                    var blob = new Blob([jsonse], {type: "application/json"});
                                    var url = URL.createObjectURL(blob);
                                    downloadLink.href = url;
                                    downloadLink.download = "FitBit_Session_" + app.$data.session.id + "_Parameter_Set.json";

                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);

                                    app.$data.downloadParametersetButtonText ='Download <i class="fas fa-download"></i>';
                                                                    
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });

                },

                uploadParameterset:function(){

                    

                    let formData = new FormData();
                    formData.append('file', app.$data.upload_file);

                    axios.post('/session/{{id}}/', formData,
                            {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                    }
                                } 
                            )
                            .then(function (response) {     

                                app.$data.uploadParametersetMessaage = response.data.message;

                                app.updateSession(response);

                                app.$data.uploadParametersetButtonText= 'Upload <i class="fas fa-upload"></i>';
 
                            })
                            .catch(function (error) {
                                console.log(error);
                                app.$data.searching=false;
                            });                        
                },
                
                //upload a list of subjects from a csv file        
                uploadSubjects:function(){
                   

                    let formData = new FormData();
                    formData.append('file', app.$data.upload_file);

                    axios.post('/session/{{id}}/', formData,
                            {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                    }
                                } 
                            )
                            .then(function (response) {     

                                app.$data.uploadParametersetMessaage = response.data.message;
                                app.updateSubjects(response);

                                app.$data.uploadParametersetButtonText= 'Upload <i class="fas fa-upload"></i>';
                                                                                
                            })
                            .catch(function (error) {
                                console.log(error);
                                app.$data.searching=false;
                            });                        
                },

                //direct upload button click
                uploadAction:function(){
                    if(app.$data.upload_file == null)
                        return;

                    app.$data.uploadParametersetMessaage = "";
                    app.$data.uploadParametersetButtonText = '<i class="fas fa-spinner fa-spin"></i>';

                    if(app.$data.upload_mode == "parameters")
                    {
                        this.uploadParameterset();
                    }
                    else
                    {
                        this.uploadSubjects();
                    }

                },

                handleFileUpload:function(){
                    app.$data.upload_file = this.$refs.file.files[0];
                    //$('parameterFileUpload').val("");
                    app.$data.upload_file_name = app.$data.upload_file.name;

                    },

                //import parameters
                importParameters:function(){                   
                    
                    axios.post('/session/{{id}}/', {
                                    action :"importParameters" ,     
                                    formData : $("#parametersImportForm").serializeArray(),                                                                                                                                                          
                                })
                                .then(function (response) {     
                                    app.updateSession(response);       
                                    $('#importParametersModal').modal('toggle');                                  
                                })
                                .catch(function (error) {
                                    console.log(error);
                                });                        
                },

                //show edit parameters modal
                showEditParameters:function(){
                    app.clearMainFormErrors();
                    app.$data.cancelModal=true;
                    app.$data.sessionParametersBeforeEdit = Object.assign({}, app.$data.session.parameterset);
                    $('#editSessionParametersModal').modal('show');                   
                },

                //fire when edit experiment model hides, cancel action if nessicary
                hideEditParameters:function(){
                    if(app.$data.cancelModal)
                    {
                        Object.assign(app.$data.session.parameterset, app.$data.sessionParametersBeforeEdit);
                        app.$data.sessionBeforeEdit=null;
                    }
                },

                //show edit parameters modal
                showEditSession:function(){
                    app.clearMainFormErrors();
                    app.$data.cancelModal=true;
                    app.$data.sessionBeforeEdit = Object.assign({}, app.$data.session);
                    $('#editSessionModal').modal('show');                   
                },

                //fire when edit experiment model hides, cancel action if nessicary
                hideEditSession:function(){
                    if(app.$data.cancelModal)
                    {
                        Object.assign(app.$data.session, app.$data.sessionBeforeEdit);
                        app.$data.sessionBeforeEdit=null;
                    }
                },

                //show edit parameters modal
                showEditSubject:function(s_id,index){
                    app.clearMainFormErrors();
                    app.$data.cancelModal=true;
                    app.$data.currentSubjectIndex = index
                    app.$data.subjectBeforeEdit = Object.assign({}, app.$data.session_subjects[index]);
                    app.$data.currentSubject = app.$data.session_subjects[index];
                    $('#editSubjectModal').modal('show');                   
                },

                //fire when edit experiment model hides, cancel action if nessicary
                hideEditSubject:function(){
                    if(app.$data.cancelModal)
                    {
                        index = app.$data.currentSubjectIndex;

                        if(index != -1)
                        {
                            Object.assign(app.$data.session_subjects[index], app.$data.subjectBeforeEdit);
                            app.$data.subjectBeforeEdit=null;
                        }
                    }
                },

                //show send invitation
                showSendInvitations:function(){
                   
                    $('#sendMessageModalCenter').modal('show');                   
                },

                //hide send invitation
                hideSendInvitations:function(){
                    app.$data.emailResult="";
                },

                //show cancel session
                showCancelSession:function(){
                   
                   $('#sendCancelationsModalCenter').modal('show');                   
               },

                //hide cancel session
                hideCancelSession:function(){
                   app.$data.emailResultCancelation="";
               },
                            
                //show edit parameters modal
                showImportParameters:function(){

                    $('#importParametersModal').modal('show');                   
                },

                //fire when edit experiment model hides, cancel action if nessicary
                hideImportParameters:function(){
                    if(app.$data.cancelModal)
                    {
                        // index = currentSubjectIndex;

                        // if(index != -1)
                        // {
                        //     Object.assign(app.$data.session_subjects[index], app.$data.subjectBeforeEdit);
                        //     app.$data.subjectBeforeEdit=null;
                        // }
                    }
                },
            
                //fire when show upload parameters
                showUploadParameters:function(upload_mode){
                    app.$data.upload_mode = upload_mode;
                    app.$data.uploadParametersetMessaage = "";
                    $('#parameterSetModal').modal('show');
                },

                hideUploadParameters:function(){
                },
                
                displayErrors:function(errors){
                    for(var e in errors)
                    {
                        $("#id_" + e).attr("class","form-control is-invalid")
                        var str='<span id=id_errors_'+ e +' class="text-danger">';
                        
                        for(var i in errors[e])
                        {
                            str +=errors[e][i] + '<br>';
                        }

                        str+='</span>';
                        $("#div_id_" + e).append(str); 

                        var elmnt = document.getElementById("div_id_" + e);
                        elmnt.scrollIntoView(); 

                    }
                }, 

                clearMainFormErrors:function(){
                    for(var item in app.$data.session.parameterset)
                    {
                        $("#id_" + item).attr("class","form-control");
                        $("#id_errors_" + item).remove();
                    }

                    for(var item in app.$data.session)
                    {
                        $("#id_" + item).attr("class","form-control");
                        $("#id_errors_" + item).remove();
                    }

                    s = app.$data.subject_form_ids;
                    for(var i in s)
                    {
                        $("#id_" + s[i]).attr("class","form-control");
                        $("#id_errors_" + s[i]).remove();
                    }
                },       
                
                //graphs
                //change graph toggle state
                updateToogleState:function(toggleState){
                   app.$data.toggleState = toggleState;
                   Vue.nextTick(app.updateCanvases());    
                },

                //update canvas with current toggle state
                updateCanvases:function(){

                    var el = $('#healthChart');
                    el.attr('width', parseInt(el.css('width')))
                    el.attr('height', parseInt(el.css('height')))
                    
                    periodCount = 0;
                    ss = app.$data.session_subjects;

                    if(ss.length == 0) return;   

                    periodCount = ss[0].heart_minutes.length;                 
                    if(periodCount == 0 ) return;

                    gp=app.$data.graph_parameters;

                    if(app.$data.toggleState == "heart")
                    {
                        app.drawAxis("healthChart",0,gp.x_max_heart,2,
                                                        0,periodCount,periodCount,
                                                        "Minutes Exercising","Period");

                        for(var j=0;j<ss.length;j++)
                        {
                            //console.log(j);
                            app.drawLine("healthChart",0,gp.x_max_heart,
                                                    0,periodCount,
                                                    ss[j].heart_minutes,1,ss[j].display_color);
                        }
                    
                    
                    }
                    else
                    {
                        app.drawAxis("healthChart",0,gp.x_max_immune,2,
                                                    0,periodCount,periodCount,
                                                    "Hours Asleep","Period");    

                                                    for(var j=0;j<ss.length;j++)
                        {
                            //console.log(j);
                            app.drawLine("healthChart",0,gp.x_max_immune,
                                                    0,periodCount,
                                                    ss[j].immune_minutes,1,ss[j].display_color);
                        }  
                    }          
                },

                drawAxis: function (chartID,yMin,yMax,yTickCount,xMin,xMax,xTickCount,yLabel,xLabel){
            
                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');    

                    var xScale = xMax-xMin;
                    var yScale = yMax-yMin;

                    var w = ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;
                    
                    var xTickValue=xScale/parseFloat(xTickCount);
                    var yTickValue=yScale/parseFloat(yTickCount);
                
                    ctx.moveTo(0,0);

                    //clear screen
                    // ctx.fillStyle = "white";
                    // ctx.fillRect(0,0,w,h);
                    ctx.clearRect(0,0,w,h);
                    ctx.strokeStyle="black";
                    ctx.lineWidth=3;

                    //axis
                    ctx.beginPath();
                    ctx.moveTo(marginY, margin2);
                    ctx.lineTo(marginY, h-marginX);
                    ctx.lineTo(w-margin2, h-marginX);
                    ctx.lineWidth = 3;
                    ctx.lineCap = "round";
                    ctx.stroke();

                    //y ticks
                    ctx.beginPath();                                                               
                    ctx.font="12px Georgia";
                    ctx.fillStyle = "black";
                    ctx.textAlign = "right";

                    var tempY = h-marginX;     
                    var tempYValue = yMin;

                    for(var i=0;i<=yTickCount;i++)
                    {                                       
                        ctx.moveTo(marginY, tempY);                                   
                        ctx.lineTo(marginY-5, tempY);
                        ctx.fillText(tempYValue,marginY-8,tempY+4);

                        tempY -= ((h-marginX-margin2)/ (yTickCount));
                        tempYValue += yTickValue;
                    }

                    ctx.stroke();

                    //x ticks
                    ctx.beginPath();                                                               
                    ctx.textAlign = "center";

                    var tempX = marginY;
                    var tempXValue=xMin;                                
                    for(var i=0;i<=xTickCount;i++)
                    {                                       
                        ctx.moveTo(tempX, h-marginX);                                   
                        ctx.lineTo(tempX,  h-marginX+5);
                        ctx.fillText(Math.round(tempXValue).toString(),tempX,h-marginX+18);

                        tempX += ((w-marginY-margin2)/ (xTickCount));
                        tempXValue += xTickValue;
                    }

                    ctx.stroke();

                    //labels
                    ctx.textAlign = "center";
                    ctx.fillStyle = "DimGray";
                    ctx.font="bold 14px Georgia"; 

                    ctx.save();
                    ctx.translate(14, h/2);
                    ctx.rotate(-Math.PI/2);                                                              
                    ctx.fillText(yLabel,0,0);
                    ctx.restore();

                    ctx.fillText(xLabel,w/2,h-4);
                    ctx.restore();                       
                },

                drawLine: function (chartID,yMin,yMax,xMin,xMax,dataSet,markerWidth,markerColor){

                    if(document.getElementById(chartID) == null)
                    {
                        return;
                    }

                    if(app.$data.session.current_period=="---")
                    {
                        return;
                    }

                    var canvas = document.getElementById(chartID),
                        ctx = canvas.getContext('2d');           

                    var w =  ctx.canvas.width;
                    var h = ctx.canvas.height;
                    var marginY=45;
                    var marginX=40;
                    var margin2=10;
                    var tickLength=3;

                    ctx.save();

                    ctx.strokeStyle = markerColor;
                    ctx.fillStyle = markerColor;
                    ctx.lineWidth = markerWidth;

                    ctx.translate(marginY, h-marginX);
                    ctx.moveTo(0, 0);

                   
                    for(i=0;i<dataSet.length;i++)
                    {
                        //stop line at current period
                        if(i >= app.$data.session.current_period-1)
                        {
                            break;
                        }

                        x = app.convertToX(i+1,xMax,xMin,w-marginY-margin2,markerWidth);
                        y = app.convertToY(dataSet[i],yMax,yMin,h-marginX-margin2,markerWidth);

                        //ignore gaps
                        if(i>0)
                        {
                            if(dataSet[i-1] >= 0 && dataSet[i] >= 0)
                            {
                                x1 = app.convertToX(i,xMax,xMin,w-marginY-margin2,markerWidth);
                                y1 = app.convertToY(dataSet[i-1],yMax,yMin,h-marginX-margin2,markerWidth);

                                ctx.beginPath();
                                ctx.moveTo(x1,y1);
                                ctx.lineTo(x,y);
                                ctx.stroke();
                            }
                           
                        }
                             
                        if(dataSet[i] >= 0 )
                        {
                            ctx.beginPath();
                            ctx.arc(x,y,3,0,2*Math.PI);
                            ctx.fill();   
                        }                    

                    }    

                    
                        
                    ctx.restore();                                         
                },

                convertToX:function(tempValue,maxValue,minValue,tempWidth, markerWidth){
                    tempT = tempWidth / (maxValue-minValue);

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return (tempT * tempValue - markerWidth/2);
                },

                convertToY:function(tempValue,maxValue,minValue,tempHeight, markerHeight){
                    tempT = tempHeight / (maxValue-minValue);

                    if(tempValue > maxValue) tempValue=maxValue;
                    if(tempValue < minValue) tempValue=minValue;

                    tempValue-=minValue;

                    if(tempValue>maxValue) tempValue=maxValue;

                    return(-1 * tempT * tempValue - markerHeight/2)
                },
            },

            mounted: function(){
                this.getSession();        
                $('#editSessionParametersModal').on("hidden.bs.modal", this.hideEditParameters);  
                $('#editSessionModal').on("hidden.bs.modal", this.hideEditSession);   
                $('#importParametersModal').on("hidden.bs.modal", this.hideImportParameters);
                $('#sendMessageModalCenter').on("hidden.bs.modal", this.hideSendInvitations); 
                $('#sendCancelationsModalCenter').on("hidden.bs.modal", this.hideCancelSession);  
                $('#editSubjectModal').on("hidden.bs.modal", this.hideEditSubject);  
                $('#hideUploadParameters').on("hidden.bs.modal", this.hideEditSubject); 
            },
        });

    });

    </script>

    <style>
        canvas {
            background-color: white; 
            width: 100%;
            height: 500px;
        }
    </style>
{%endblock head%}

{%block content%}
<div class="row justify-content-lg-center">
    <div class="col col-lg-12">
        <div class="row">
            <div class="col-8">
                <!-- parameters card -->
                <div class="card">
                    <div class="card-header">
                        <span class="align-middle">Parameters</span>
                        
                        <span class="float-right">
                            <button class="btn btn-outline-primary" type="button" v-on:click = "downloadParameterset()" title="Download to a file.">
                                <span v-html = "downloadParametersetButtonText"></span>
                            </button>
                            <button class="btn btn-outline-primary" type="button" v-bind:disabled = "session.started" v-on:click = "showUploadParameters('parameters')" title = "Upload from a file.">
                                Upload  <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" v-bind:disabled = "session.started" v-on:click = "showImportParameters()" title="Import from another session.">
                                Import <i class="fas fa-file-import"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" v-on:click = "showEditParameters()" title="Show edit form.">
                                Edit <i class="far fa-edit"></i>
                            </button>
                        </span>
                                                                        
                    </div>
                    <div class="card-body">
                        <!-- activity formula -->
                        <div class="row mt-2">
                            <div class="col" style="text-align: center;">
                                <!-- Activity<sub>T</sub> = P1 * Activity<sub>T-1</sub> * (1 - (1 - Activity<sub>T-1</sub>) * (P1 / P2  - FitBit<sub>T-1</sub> / (FitBit<sub>T-1</sub> + P3))) -->

                                Activity<sub>T</sub> = P1 * Activity<sub>T-1</sub> + 0.5 * (1 + Activity<sub>T-1</sub>) * (1 - P1 * Activity<sub>T-1</sub>) * (FitBit<sub>T-1</sub><sup>P2</sup> / (P3 + FitBit<sub>T-1</sub><sup>P2</sup>)) 
                            </div>                            
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.heart_activity_inital.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.heart_activity_inital"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.immune_activity_inital.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.immune_activity_inital"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.heart_parameter_1.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.heart_parameter_1"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.immune_parameter_1.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.immune_parameter_1"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.heart_parameter_2.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.heart_parameter_2"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.immune_parameter_2.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.immune_parameter_2"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.heart_parameter_3.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.heart_parameter_3"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.immune_parameter_3.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.immune_parameter_3"></span>
                            </div>
                        </div>

                        <!-- time blocks -->
                        <div class="row mt-2 border-top">
                            <div class="col" style="text-align: center;">
                               Earnings<sub>T</sub> ($) = FixedPayPerDay + (HeartPay<sub>B</sub> * HeartActivity<sub>T</sub>) + (ImmunePay<sub>B</sub> * ImmuneActivity<sub>T</sub>)
                            </div>                            
                        </div>
                        <div class="row">
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.fixed_pay_per_day.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.fixed_pay_per_day"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                               
                            </div>
                            <div class="col-1">
                               
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.minimum_wrist_minutes.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.minimum_wrist_minutes"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_1_heart_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_1_heart_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_1_immune_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_1_immune_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_1_day_count.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_1_day_count"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_2_heart_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_2_heart_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_2_immune_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_2_immune_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_2_day_count.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_2_day_count"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_3_heart_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_3_heart_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_3_immune_pay.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_3_immune_pay"></span>
                            </div>
                            <div class="col-3" style="text-align: right;">
                                {{parameterset_form.block_3_day_count.label}}:
                            </div>
                            <div class="col-1">
                                <span v-html="session.parameterset.block_3_day_count"></span>
                            </div>
                        </div>

                        <!-- treatment 3 -->
                        <div class="row mt-2 border-top">
                            <div class="col" style="text-align: Center;">
                               Treatment 3
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.treatment_3_heart_bonus.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.treatment_3_heart_bonus"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.treatment_3_immune_bonus.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.treatment_3_immune_bonus"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.treatment_3_bonus_target_count.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.treatment_3_bonus_target_count"></span>
                            </div>
                        </div>

                        <!-- graphs self -->
                        <div class="row mt-2 border-top">
                            <div class="col" style="text-align: Center;">
                                Heart Graph: Self
                            </div>
                            <div class="col" style="text-align: Center;">
                                Immune Graph: Self
                            </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_min_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.y_min_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_min_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.y_min_immune"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_max_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.y_max_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_max_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.y_max_immune"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_ticks_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.y_ticks_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.y_ticks_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.y_ticks_immune"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_min_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.x_min_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_min_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.x_min_immune"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_max_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.x_max_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_max_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.x_max_immune"></span>
                             </div>
                        </div>
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_ticks_heart.label}}:
                            </div>
                            <div class="col">
                                <span v-html="session.parameterset.x_ticks_heart"></span>
                            </div>
                            <div class="col" style="text-align: right;">
                                {{parameterset_form.x_ticks_immune.label}}:
                             </div>
                             <div class="col">
                                 <span v-html="session.parameterset.x_ticks_immune"></span>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <!-- session card -->
                <div class = "card">
                    <div class="card-header">
                        <span class="align-middle">Session</span>
                        
                        <span class="float-right">                            
                            <button class="btn btn-outline-primary" type="button" v-on:click = "showEditSession()">
                                Edit <i class="far fa-edit"></i>
                            </button>
                        </span>                                                                        
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4" style="text-align: right;">
                                {{session_form.title.label}}:
                            </div>
                            <div class="col-8">
                                <span v-html="session.title"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4" style="text-align: right;">
                                {{session_form.treatment.label}}:
                            </div>
                            <div class="col-8">
                                <span v-html="session.treatment_label"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4" style="text-align: right;">
                                {{session_form.start_date.label}}:
                            </div>
                            <div class="col-8">
                                <span v-html="session.start_date"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4" style="text-align: right;">
                                End Date:
                            </div>
                            <div class="col-8">
                                <span v-html="session.end_date"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4" style="text-align: right;">
                                Current Period:
                            </div>
                            <div class="col-8">
                                <span v-html="session.current_period"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <!-- Control card -->
                <div class = "card">
                    <div class="card-header">
                        <span class="align-middle">Control</span>                                                                        
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col" style="text-align: right;">
                                <button class="btn btn-outline-success" type="button" v-on:click = "startSession()" v-bind:disabled = "session.started">
                                    <span v-html="startSessionButtonText"></span>
                                </button>
                            </div>    
                            <div class="col">
                                <div v-if="session.started">
                                    Session Started
                                </div>
                                <div v-else>
                                    Session Not Started
                                </div>
                            </div>                        
                        </div>
                        <div class="row mt-2">
                            <div class="col" style="text-align: right;">
                                <button class="btn btn-outline-danger" type="button" v-on:click = "showCancelSession()" v-bind:disabled = "session.started === false || session.canceled">
                                    Cancel Session <i class="fas fa-ban"></i>
                                </button>
                            </div>    
                            <div class="col">
                                <div v-if="session.canceled">
                                    Session Canceled
                                </div>
                                <div v-else>
                                    
                                </div>
                            </div>                        
                        </div>
                        {%if DEBUG%}
                        <div class="row mt-2"> 
                            <div class="col" style="text-align: right;">
                               
                                <button class="btn btn-outline-danger" type="button" v-on:click = "backFillSessionsDays()" v-bind:disabled = "session.started === false">
                                    <span v-html="backFillButtonText"></span>
                                </button>
                                
                            </div>
                            <div class="col">
                            </div> 
                        </div>
                        {%endif%}
                        <div class="row mt-2"> 
                            <div class="col" style="text-align: right;">                                
                                <button class="btn btn-outline-primary" type="button" v-on:click = "showSendInvitations()" v-bind:disabled = "session.started === false">
                                    Send Invitations <i class="far fa-envelope"></i>
                                </button>                                
                            </div>
                            <div class="col">
                                <div v-if="session.invitations_sent">
                                    Invitations Sent
                                </div>
                                <div v-else>
                                    Invitations Not Sent
                                </div>
                            </div> 
                        </div>    
                        <div class="row mt-2"> 
                            <div class="col" style="text-align: right;">                                
                                <button class="btn btn-outline-primary" type="button" v-on:click = "downloadData()" v-bind:disabled = "session.started === false">
                                   <span v-html="downloadDataButtonText"></span>
                                </button>                                
                            </div>
                            <div class="col">
                                
                            </div> 
                        </div> 
                        <div class="row mt-2"> 
                            <div class="col" style="text-align: right;">                                
                                <button class="btn btn-outline-primary" type="button" v-on:click = "downloadEarnings()" v-bind:disabled = "session.started === false">
                                   <span v-html="downloadEarningsButtonText"></span>
                                </button>                                
                            </div>
                            <div class="col">
                                <input class="form-control" type="date" id="earningsDownloadDate_id" v-model="earningsDownloadDate">
                            </div> 
                        </div>                                         
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col">
                <!-- subject card -->
                <div class="card">                  
                    <div class="card-header">
                        <span class="align-middle">Subjects ([[session_subjects.length]])</span>

                        <span class="float-right">
                            [[last_refresh]]
                            <button class="btn btn-outline-primary" type="button" v-on:click = "refreshSubjectTableClick()" title="Refresh the subjects table.">
                                <span v-html = "refreshSubjectTableButtonText"></span>
                            </button>
                            <button class="btn btn-outline-primary" type="button" v-on:click = "showFitbitStatus()" title="Test and show Fitbit connection status.">
                                <span v-html = "showFitbitStatusButtonText"></span>
                            </button>
                            <button class="btn btn-outline-primary" type="button" v-bind:disabled = "session.started" v-on:click ="showUploadParameters('subjects')" title="Upload a list of subjects from the Recruiter.">
                                Upload  <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn btn-outline-success" type="button" v-on:click = "addSubject()" v-bind:disabled = "session.started" title="Add new subject to the session.">
                                <span v-html="addSubjectButtonText"></span>
                            </button>
                        </span>
                                                                        
                    </div>
                    <div class="card-body">                      
                                        
                        <!-- session list -->
                        <table class="table table-hover table-condensed">                            

                            <!-- <caption style="caption-side:top;text-align: center;">Subjects</caption> -->

                            <thead>
                                <th>
                                    Name
                                </th> 
                                <th style="text-align: center;">
                                    Color
                                </th>
                                <th style="text-align: center;">
                                    Login<br>Link                    
                                </th>
                                <th style="text-align: center;">
                                    Consent<br>Pre/Post Survey                  
                                </th>                                
                                <th style="text-align: center;">
                                    Check In, PayPal<br>Today               
                                </th>
                                <th style="text-align: center;">
                                    Today's<br>Earnings                    
                                </th>
                                <th style="text-align: center;">
                                    Heart<br>Score                    
                                </th>
                                <th style="text-align: center;">
                                    Sleep<br>Score                    
                                </th>
                                <th style="text-align: center;">
                                    Wrist Time<br>
                                    YDA|2DAY                     
                                </th>
                                <th style="text-align: center;">
                                    Last Experiment<br>Sync                  
                                </th>
                                <th style="text-align: center;">
                                    FitBit                                     
                                </th>                                                      
                                <th  style="text-align: center;">
                                    Control
                                </th>
                            </thead>

                            <tbody id="subjectList">                                                  
                                <tr v-for="(s,index) in session_subjects" v-bind:key="s.id">                                                                          
                                    <td> 
                                        <span v-html="s.name"></span>                                      
                                    </td>
                                    <td style="text-align: center;">
                                        <span  v-bind:style="{ color: s.display_color}"><i class="fas fa-palette"></i></span>
                                    </td>
                                    <td style="text-align: center;"> 
                                        <button type="button" class="btn btn-outline-primary btn-sm" v-on:click = "copySubjectLinkToClipboard(s.login_url)" title="Copy subject login URL">
                                            <i class="far fa-copy"></i>   
                                        </button>
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-if="s.consent_required === false" style="color:green">
                                            <i class="far fa-check-circle"></i>
                                        </span>
                                        <span v-else style="color:red">
                                            <i class="far fa-times-circle"></i>
                                        </span>

                                        <span v-if="s.questionnaire1_required === false" style="color:green">
                                            <i class="far fa-check-circle"></i>
                                        </span>
                                        <span v-else style="color:red">
                                            <i class="far fa-times-circle"></i>
                                        </span>

                                        <span v-if="s.questionnaire2_required === false" style="color:green">
                                            <i class="far fa-check-circle"></i>
                                        </span>
                                        <span v-else style="color:red">
                                            <i class="far fa-times-circle"></i>
                                        </span>

                                    </td>
                                    <td style="text-align: center;">
                                        <span v-if="s.todays_stats.check_in" style="color:green">
                                            <i class="far fa-check-circle"></i>
                                        </span>
                                        <span v-else style="color:red">
                                            <i class="far fa-times-circle"></i>
                                        </span>

                                        <span v-if="s.todays_stats.pay_pal" style="color:green">
                                            <i class="far fa-check-circle"></i>
                                        </span>
                                        <span v-else style="color:red">
                                            <i class="far fa-times-circle"></i>
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-html="s.todays_stats.earnings"></span>  
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-html="s.todays_stats.heart_score"></span> | <span v-html="s.todays_stats.heart_time"></span> | <span v-html="s.todays_stats.heart_bpm"></span>                  
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-html="s.todays_stats.immune_score"></span> | <span v-html="s.todays_stats.immune_time"></span>                    
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-html="s.todays_stats.wrist_time"></span>
                                    </td>
                                    <td style="text-align: center;">
                                        <span v-html = "s.fitBit_last_synced"></span>
                                    </td>
                                    <td style="text-align: center;">                                        
                                        <a :href="s.fitBit_Link"><span v-html="'Setup'"></span></a>

                                        <span v-if = "s.get_fitbit_status === false">
                                            
                                        </span>
                                        <span v-else-if = "s.fitBit_Attached">
                                            <span style="color: green;"><i class="far fa-check-circle"></i></span>
                                        </span>
                                        <span v-else style="color: red;">
                                            <i class="far fa-times-circle"></i>
                                        </span>                             
                                    </td>                               
                                    <td style="text-align: center;">
                                        <button v-bind:id="'editSubject' + s.id" type="button" class="btn btn-outline-primary btn-sm" v-on:click = "showEditSubject(s.id,index)" title="Edit subject info">
                                            <i class="far fa-edit"></i>  
                                        </button> 
                                        <button v-bind:id="'deleteSubject' + s.id" type="button" class="btn btn-outline-danger btn-sm" v-on:click = "deleteSubject(s.id)" title="Delete subject">
                                            <i class="fas fa-user-minus fa-xs"></i>  
                                        </button>
                                    </td>                            
                                </tr>                                                    
                            </tbody>
                            
                        </table>                 
                        
                    </div>                    
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col">
                <!-- graph card -->
                <div class="card">
                    <div class="card-header">
                        <span class="align-middle">Subject Activity</span>

                        <span class="float-right">
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-secondary active">
                                    <input type="radio" name="options" id="option1" autocomplete="off" checked v-on:click="updateToogleState('heart')"> <i class="far fa-heart"></i>
                                </label>
                                <label class="btn btn-secondary">
                                    <input type="radio" name="options" id="option2" autocomplete="off" v-on:click="updateToogleState('immune')"> <i class="fas fa-bed"></i>
                                </label>                    
                            </div>
                        </span>
                                                                        
                    </div>
                    <div class="card-body">
                        <canvas key="healthChart" id="healthChart" style="border-style: solid;border-width: 1px;"></canvas>
                    </div> 
                </div>
            </div>
        </div>
                        
    </div>
</div>    

{%include "modals/editSessionParametersModal.html"%}
{%include "modals/editSessionModal.html"%}
{%include "modals/editSubjectModal.html"%}
{%include "modals/importParametersModal.html"%}
{%include "modals/sendInvitationModal.html"%}
{%include "modals/sendCancelationModal.html"%}
{%include "modals/uploadParametersSetModal.html"%}

{%endblock content%}